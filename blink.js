var query_compression=0;fname=["node","back","root","timer","moves","giver","receiver","metaNode","passUseMode"];var mover=document.getElementById("wrap");var d="";var e="";var b="";var root=0;var firstload=1;var querystring="";var backIt="start";var content;var old;var use;var giver=0;var receiver=0;var deadX="";var deadEvent="";var links=1;var back=1;var scrollPosition;var invText="";var inv=1;var metaNode=0;var metaContent;var wait;var dCount=1;var thought;var debugMode=0;var iBuffer="";var inventoryDescArray=[];var metaVisible=0;var restored=0;var parent;var inventorySystem=1;var waitSystem=0;var saveLink;var f={};var i={};var scene_name=[];var iName=[];var iNameSorted=[];var node_function=[];var file_node_jumped;var timeouts=[];i.z="sdssd";f.node="start";f.back="start";back=1;f.root="start";f.metaNode=0;f.reward=0;if(typeof external_load_text==="undefined"){external_load_text='<div id=\'external_load_text\'>This game is powered by <a target="_blank" href="http://bloomengine.com/blink">Blink!</a></div>'}function createDeadLinks(h){var k=h.split("{").length-1;var g;var j;for(var l=0;l<k;l++){g=h.replace(/^.*\{(.*)}.*$/,"$1");ysplit=g.split("|");j="<span class='deadLink'>"+ysplit[0]+"</span>";g="{"+g+"}";h=h.replace(g,j)}return h}function is_file_jump(a){if(a.search(".js")!=-1){return true}else{return false}}function createLinks(l){var j=l.split("{").length-1;for(var a=0;a<j;a++){var k=l.replace(/^.*\{(.*)}.*$/,"$1");var h=k.split("|");var g="<a onClick=\"process('"+h[1]+"'); return false;\">"+h[0]+"</a>";if(is_file_jump(h[1])){g='<a href="?file='+h[1];if(h[2]){g+="&file_node="+h[2]}g+="&i="+buildSaveLink(i,iName)+'">'+h[0]+"</a>"}k="{"+k+"}";l=l.replace(k,g)}return l}function pageHeight(){return window.innerHeight!=null?window.innerHeight:document.body!=null?document.body.clientHeight:null}query=getParameterByName("f");function process(g,r,t,p){if(typeof daemon=="function"){daemon()}if(!p){p={}}if(!t){t=0}if(!r){r=0}f.node=g;f.giver=r;f.receiver=t;if(!firstload){if(!p.manual){$("#new a").replaceWith(function(){return'<span class="deadLink">'+$(this).text()+"</span>"})}$("#new .back").remove();if($("#new").text()){document.getElementById("new").setAttribute("class","old")}document.getElementById("new").removeAttribute("id")}if(metaNode){f.back=="metaNode";metaNode=0}else{f.back=backIt}if(firstload){let x=check_if_duplicated(user_variables);if(x.length){alert("There are duplicated items in user_variables: "+x.join()+"\nPlease remove duplicates or else there will be bugs!")}fname=fname.concat(user_variables);fname.forEach(function(u){f[u]="0"});iName.forEach(function(u){i[u]="0"});f.node="start";f.back="start";f.root="start";if(debugMode){$("#wrap").append('<div id="debug"><a id="debugShowHide" href="javascript:debugShowHide()">Hide Debug</a><div id="debugContent"></div></div><!--debug-->')}resize();metaVisible=1}if(firstload){document.getElementById("title").setAttribute("id","inner");var m=[]}if(getParameterByName("f")&&firstload){m[0]=getParameterByName("f");if(query_compression){m[0]=LZString.decompressFromEncodedURIComponent(m[0])}var s=m[0].split("|");f=syncVariables(m[0],fname,f);for(var h=0;h<=fname.length;h++){if(("fquerysplit: "+s[h])==undefined){}if(s[h]=="0"){s[h]=0}}g=f.node}if(getParameterByName("i")&&firstload){m[1]=getParameterByName("i");if(query_compression){m[1]=LZString.decompressFromEncodedURIComponent(m[1])}i=syncVariables(m[1],iName,i);for(var h=0;h<=iName.length-1;h++){}for(var h=0;h<=iName.length;h++){}}else{if(firstload&&!getParameterByName("f")&&!getParameterByName("i")){document.getElementById("startScreenInner").innerHTML="<h1>"+gameTitle+"</h1><h2>by "+gameAuthor+"</h2>";if(readCookie("state")){document.getElementById("startScreenInner").innerHTML+='<p>Do you want to <a onClick="restore(); return false;">continue</a> or start a <a onClick="newGame(); return false;">new game</a>?</p>'}else{document.getElementById("startScreenInner").innerHTML+='<p>Start a <a onClick="newGame(); return false;">new game</a>.</p>'}set_starting_variables();if(getParameterByName("file_node")&&!file_node_jumped){f.node=getParameterByName("file_node");g=f.node;file_node_jumped=1}}}for(var h=1;h<fname.length;h++){}if(metaNode){backIt="metaNode"}else{backIt=f.node}f.moves=Number(f.moves);if(firstload){if(debugMode){}if(f.debugPane==undefined){f.debugPane=1}else{if(f.debugPane){f.debugPane=0;debugShowHide()}}}old_i=[];for(var h=0;h<iName.length;h++){(function(u){(function(){old_i[iName[u]]=i[iName[u]]})()})(h)}z=buildSaveLink(f,fname);zz=buildSaveLink(i,iName);if(query_compression){z=LZString.compressToEncodedURIComponent(z);zz=LZString.compressToEncodedURIComponent(zz)}var k="f="+z+"&i="+zz;if(getParameterByName("file")){k+="&file="+getParameterByName("file")}saveLink='<a href="?'+k+'">Save Game</a> ';setCookie("state",z,360);setCookie("inv",zz,360);if(!firstload){console.log("set "+JSON.stringify(f));localStorage.setItem("save_f",JSON.stringify(f));localStorage.setItem("save_i",JSON.stringify(i))}if(f.receiver){giver_type=inventoryDescArray[f.giver]["type"];use=0;nodes(f.node)}else{if(f.giver){d+="<div class='i_out'>";inventoryDescArray[g].funct();d+="</div>"}else{if(f.node){nodes(f.node)}}}highlight_items=(function(){var v=[];for(var u=0;u<iName.length;u++){if(old_i[iName[u]]!=i[iName[u]]){v.push(iName[u])}}return v})();debug();if(!metaNode&&f.back!="metaNode"){if(root){f.timer++}f.moves++}else{if(metaNode){f.back="metaNode";back="metaNode"}}if(e){e='<div class="event">'+e+"</div>"}if(b){b='<div class="event">'+b+"</div>"}if(!links&&!p.manual){d=createDeadLinks(d)}d=b+d+e;if(getParameterByName("file")){$("#owrap").hide();$("#wrap").css("display","block");$("#startScreen").css("display","none")}if(getParameterByName("f")&&firstload||getParameterByName("i")&&firstload){$("#owrap").hide();$("#wrap").css("display","block");$("#startScreen").css("display","none");if(getParameterByName("f")){$("#content").append("<div class=\"old\"><div class='metaText'><h2>Save/Restore Point</h2><p>Bookmark this URL to return to this point. The game also automatically saves your progress and you can choose 'continue' from the start screen. (Uses browser cache) </p></div></div>"+external_load_text)}if(typeof new_game_external_code=="function"){new_game_external_code()}}if(root){f.root=g}deadX=d;if(back==1&&!root&&links){d+='<p class="back">{Return|'+f.root+"}</p>"}else{if(back!=1&&back!=0){d+='<p class="back">{Return|'+back+"}</p>"}}d=createLinks(d);$("#content").append('<div id="new"></div>');d+='<div style="clear:both"></div>';$("#new").html(createLinks(shortcut_characters(d))).promise().done(function(){if(!firstload&&f.moves>2){$("#wrap").scrollTo("#new",600)}else{$("#wrap").animate({scrollTop:"+=100"},10);$("#wrap").scrollTo("#content",600)}});d="";e="";b="";if(inventorySystem){if(use||root&&back!=0&&inv!=0){d+=outputInventory()}else{d+=createDeadLinks(outputInventory())}if(use||links&&back&&inv!=0){var q=d.split("{").length-1;for(var h=0;h<q;h++){y=d.replace(/^.*\{(.*)}.*$/,"$1");var j=y.split("|");parsedUrl="<a onClick=\"process('"+j[1]+"','"+j[1]+"'); return false;\">"+j[0]+"</a>";if(use){parsedUrl="<a onClick=\"process('"+f.node+"','"+j[1]+"','"+f.node+"'); return false;\">"+j[0]+"</a>"}y="{"+y+"}";d=d.replace(y,parsedUrl)}var a;if(use&&!f.giver){a="<div id=\"inventory\" class='use'><h2>"+meta_labels.use+'</h2><div id="arrow"></div><div id="inv_wrap">'+d+"</div></div></div>"}else{a='<div id="inventory"><h2>'+meta_labels.inventory+'</h2><div id="inv_wrap">'+d+"</div></div>"}if(inv){document.getElementById("rail").innerHTML=a}}else{if(!links){d=createDeadLinks(d)}document.getElementById("rail").innerHTML='<div id="inventory" ><h2>'+meta_labels.inventory+'</h2><div id="inv_wrap">'+d+"</div>"}var l=iName.slice(0).sort();(function(){var w="";var v=[];for(h=0;h<iName.length;h++){if(parent){if(typeof parent!="object"){var u="#"+parent;if(!v[parent]){$(u).append("<ul></ul>");v[parent]=1}if(use){w="<a onclick=\"process('1','"+inventoryDescArray[l[h]]["node"]+"','"+f.node+"'); return false;\">"+inventoryDescArray[l[h]]["text"]+"</a>"}else{w="<a onclick=\"process('"+inventoryDescArray[l[h]]["node"]+"','"+inventoryDescArray[l[h]]["node"]+"'); return false;\">"+inventoryDescArray[l[h]]["text"]+"</a>"}$(u+" ul").append("<li class='node' id=\""+inventoryDescArray[l[h]]["node"]+'">'+w+"</li>")}}}})();if(inv==0||links==0||back==0){$(".node ul .node a").replaceWith(function(){return $("<span />",{html:$(this).html()})});$(".node ul .node span").addClass("deadLink")}$("#inventory li.node").each(function(){$(this).hide()});for(h in iName){if(i[iName[h]]==1||i[iName[h]]=="1"){var o="#inventory #"+iName[h];$(o).show()}}(function(){for(var u=0;u<highlight_items.length;u++){var v="#"+highlight_items[u];$(v).each(function(){if($(this).is(":visible")){$(this).effect("highlight",{color:"yellow"},1500)}})}})();d=""}else{$("#content").css("margin-left","0")}d="";if(f.moves<2||query){saveLink="<span class='deadLink'>Save Game</span>"}$("#metaContent").html('<a href="?">Restart</a>'+saveLink+createLinks(metaContent));f.giver=0;f.receiver=0;f.talk=0;back=1;links=1;use=0;inv=1;if(waitSystem){wait=1}else{wait=0}root=0;parent=0;if(firstload){firstload=0;query=0;$("#wrap").click(function(u){showHideMeta(1)});$("#metaButton").click(function(u){myEventHandler(u)})}jsprettify.prettify();resize()}function shortcut_characters(a){var a=escape(a);a=(a).replace(/%0A/g,"%3Cbr%3E");return unescape(a)}function buildSaveLink(a,g){var h="";g.forEach(function(j){a=cleanupZeros(a);h+=a[j]+"|"});return h}function add(h,g,k){iName.push(g);inventoryDescArray[g]=[];inventoryDescArray[g]["node"]=g;inventoryDescArray[g]["text"]=h;inventoryDescArray[g]["funct"]=k;var j=i;var a=f;if(parent&&typeof parent!="object"){inventoryDescArray[g]["parent"]=parent;parent=0}k();if(thought){inventoryDescArray[g]["type"]="thought"}else{inventoryDescArray[g]["type"]="object"}i=j;f=a;thought=0;object=0;parent=0;d=""}window.onresize=resize;function restore(){$("#owrap").hide();$("#content").html("<div id='new'><h2>Restored game</h2></div>"+external_load_text);var a=readCookie("inv");a=a.substring(0,a.length-1);var g=readCookie("state");g=g.substring(0,g.length-1);console.log("get"+localStorage.getItem("save_f"));f=JSON.parse(localStorage.getItem("save_f"));i=JSON.parse(localStorage.getItem("save_i"));process(f.node,f.giver,f.receiver);hideStartScreen();$("#wrap").css("display","block")}function setCookie(h,g,a){var k=new Date();var j=new Date();if(a==null||a==0){a=1}j.setTime(k.getTime()+3600000*24*a);document.cookie=h+"="+escape(g)+";expires="+j.toGMTString()}function readCookie(g){var j=" "+document.cookie;var a=j.indexOf(" "+g+"=");if(a==-1){a=j.indexOf(";"+g+"=")}if(a==-1||g==""){return""}var h=j.indexOf(";",a+1);if(h==-1){h=j.length}return unescape(j.substring(a+g.length+2,h))}function toggleLayer(h){var a,g;if(document.getElementById){a=document.getElementById(h)}else{if(document.all){a=document.all[h]}else{if(document.layers){a=document.layers[h]}}}g=a.style;if(g.display==""&&a.offsetWidth!=undefined&&a.offsetHeight!=undefined){g.display=(a.offsetWidth!=0&&a.offsetHeight!=0)?"block":"none"}g.display=(g.display==""||g.display=="block")?"none":"block"}function newGame(){var a="";hideStartScreen();$("#wrap").css("display","block");$("#content").html("<div id='new'><h2>New game</h2></div>"+external_load_text);process("start");if(typeof new_game_external_code=="function"){new_game_external_code()}resize();metaVisible=1}function resize(){$("#debug").css("max-height",function(){return $(window).height()});$("#debugContent").css("max-height",function(){return $(window).height()-60});$("#wrap, #content").css("min-height",function(){return $(window).height()});$("#debugShowHide").css("height",function(){return $("#debug").height()});if($("#inv_wrap").height()<$(window).height()){$("#inv_wrap").css("height","auto")}if($(window).height()<$("#inv_wrap").height()+75){$("#inv_wrap").height($(window).height()-75)}}function build(g){d=d+g}function buildInv(g){d=d+g}function event(g){e=e+g}function buildNew(g){d=g}function form_params(j){var a=new Array();var h=j.elements.length;for(var g=0;g<h;g++){element=j.elements[g];if(element.tagName=="TEXTAREA"){a[element.name]=element.value}else{if(element.tagName=="INPUT"){if(element.type=="text"||element.type=="hidden"||element.type=="password"){a[element.name]=element.value}else{if(element.type=="radio"&&element.checked){if(!element.value){a[element.name]="on"}else{a[element.name]=element.value}}else{if(element.type=="checkbox"&&element.checked){if(!element.value){a[element.name]="on"}else{a[element.name]=element.value}}}}}}}return a}function serialize(g){if(!g||!g.elements){return}var m=[],k,l,a;var h=function(j,p){m.push(encodeURIComponent(j)+"="+encodeURIComponent(p))};var o=g.elements;for(k=0;k<o.length;k+=1,a=false){if(o[k].name.length>0){switch(o[k].type){case"select-one":a=true;case"select-multiple":for(l=0;l<o[k].options.length;l+=1){if(o[k].options[l].selected){h(o[k].name,o[k].options[l].value);if(a){break}}}break;case"checkbox":case"radio":if(!o[k].checked){break}default:h(o[k].name,o[k].value);break}}}return m.join("&")}function togglez(g){var h="#debug_"+g;var a=$(h).val();if(a=="0"||!a){$(h).val("1")}else{$(h).val("0")}}function debug(){dt='<div id="debug-block"><form id="debugForm" >';function a(h,g){for(c in g){dt+='<div class="form_block"><label>';dt+='<a href="#" title="'+g[c]+'"onclick="togglez(\''+g[c]+"'); return false;\">";dt+=g[c];dt+=":</a>";dt+="</label>";dt+='<input type="text" id="debug_';dt+=g[c];dt+='" name="';dt+=g[c];dt+='" value="';dt+=h[g[c]];dt+='"  />';dt+="</div>"}}dt+='<div id="flags">';a(f,fname);dt+="</div>";dt+='<div id="inv">';a(i,iName);dt+="</div>";dt+='<button type="submit" class="button" onclick="buildDebugLink(); return false;">Submit</button>';dt+="</form></div>";name_element=document.getElementById("dc");if(debugMode){document.getElementById("debugContent").innerHTML=dt;$("#owrap").on("click",function(g){$("#owrap").hide()})}resize()}function buildDebugLink(){var a="";var g="";$("#flags .form_block input").each(function(j,h){a+=$(this).val()+"|"});$("#inv .form_block input").each(function(j,h){g+=$(this).val()+"|"});if(query_compression){a=LZString.compressToEncodedURIComponent(a);g=LZString.compressToEncodedURIComponent(g)}document.location.href="?f="+a+"&i="+g}function debugShowHide(){if(f.debugPane){$("#debug").css("left",-1*$("#debug").width());f.debugPane=0;$("#debugShowHide").text("Show debug");$("#debugShowHide").css("background-image","url(arrow-right.gif)")}else{$("#debug").css("left","0");f.debugPane=1;$("#debugShowHide").text("Hide debug");$("#debugShowHide").css("background-image","url(arrow-left.gif)")}}metaVisible=1;function myEventHandler(a){showHideMeta();if(!a){a=window.event}if(a.stopPropagation){a.stopPropagation()}else{a.cancelBubble=true}}function showHideMeta(a){var g=$("#metaContent").height();var h=g*-1;if(metaVisible||a){$("#meta").animate({top:h-5},1000,function(){metaVisible=0;$("#metaButton").html('Menu <img src="arrow-down.gif">')})}else{if(metaVisible==0){$("#meta").animate({top:0},150,function(){metaVisible=1;$("#metaButton").html('Menu <img src="arrow-up.gif">')})}}}function hideStartScreen(){startScreenHeight="-="+$("#startScreen").height();$("#startScreen").animate({top:startScreenHeight},500,"swing",function(){$("#startScreen").css("display","none")})}function syncVariables(a,j,k){var h=a.split("|");for(var g=0;g<=j.length-1;g++){if(exist(h[g])){k[j[g]]=h[g]}else{k[j[g]]=0}if(h[g]=="undefined"||h[g]==""){k[j[g]]=0}}return k}function cleanupZeros(a){for(var g in a){if(a[g]=="undefined"||a[g]==""){a[g]="0"}if(a[g]==="0"||a[g]==="1"){a[g]=a[g]-0}}return a}var nodeArray=[];var rootList=[];function n(g,h){var a=f;var j=i;nodeArray[g]=h;if(root){rootList.push(g)}f=a;i=j;root=0}function outputInventory(){var m;var g;var h="";var j=i;var k=f;for(m=0;m<iName.length;m++){if(inventoryDescArray[iName[m]]["type"]=="thought"){g=1}}function a(o){iNameSorted=iName.slice(0).sort();h+="<li class='node' id=\""+inventoryDescArray[iNameSorted[o]]["node"]+'">{'+inventoryDescArray[iNameSorted[o]]["text"]+"|"+inventoryDescArray[iNameSorted[o]]["node"]+"}</li>"}function l(){iNameSorted=iName.slice(0).sort();for(var q=0;q<inventoryTypes.length;q++){h+="<div class='inventory_type' id='"+inventoryTypes[q][0]+"'><h3>"+inventoryTypes[q][1]+"</h3><ul>";var o=""+inventoryTypes[q][0];for(var p=0;p<iName.length;p++){if(inventoryDescArray[iNameSorted[p]]["type"]==o&&!inventoryDescArray[iNameSorted[p]]["parent"]){a(p)}}h+="</ul></div>"}}if(inventoryTypes.length>0){l()}else{h+="<ul>";for(m=0;m<iName.length;m++){if(!inventoryDescArray[iNameSorted[m]]["parent"]){a()}}h+="</ul>"}return h};